name: Build and release znnd and libznn

on:
  push:
    branches:
      - master
      - cicd
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  harden_security:
    name: Harden Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
      - name: Ensure SHA pinned actions
        uses: zgosalvez/github-actions-ensure-sha-pinned-actions@74606c30450304eee8660aae751818321754feb1
  xgo:
    needs: harden_security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
      - name: Install zip utility
        run: |
          sudo apt update
          sudo apt upgrade -y
          sudo apt install -y zip
      - name: Check Go environment
        run: |
          go env
      - name: Run tests
        run: |
          for s in $(go list ./...); do if ! go test -failfast -v -p 1 $s; then exit 1; fi; done
      # - name: Check for Go vulnerabilities
      #   run: |
      #     go install golang.org/x/vuln/cmd/govulncheck@latest
      #     /home/runner/go/bin/govulncheck -json ./...
      - name: Build znnd
        uses: crazy-max/ghaction-xgo@682253ce1d3dd7a78c5120c703c9f3811dbf8cb2
        with:
          xgo_version: latest
          go_version: latest
          dest: build
          prefix: znnd
          pkg: cmd/znnd
          targets: darwin/arm64,darwin/amd64,windows/amd64,linux/amd64,linux/arm64
          v: true
          x: true
          ldflags: -s -w
          buildvcs: false
          buildmode: default
          trimpath: true
      - name: Build libznn
        uses: crazy-max/ghaction-xgo@682253ce1d3dd7a78c5120c703c9f3811dbf8cb2
        with:
          xgo_version: latest
          go_version: latest
          dest: build
          prefix: libznn
          pkg: cmd/libznn
          targets: darwin/arm64,darwin/amd64,windows/amd64,linux/amd64,linux/arm64
          v: true
          x: true
          tags: libznn
          ldflags: -s -w
          buildvcs: false
          buildmode: c-shared
          trimpath: true
      - name: Run makefat for darwin builds
        run: |
          cd ..
          git clone https://github.com/randall77/makefat.git
          cd makefat/
          git checkout 7ddd0e42c8442593c87c1705a5545099604008e5
          go build -o mainfat makefat.go
          ./mainfat ../go-zenon/build/libznn-darwin-universal.dylib ../go-zenon/build/libznn-darwin-amd64.dylib ../go-zenon/build/libznn-darwin-arm64.dylib
          ./mainfat ../go-zenon/build/znnd-darwin-universal ../go-zenon/build/znnd-darwin-amd64 ../go-zenon/build/znnd-darwin-arm64
      - name: Go back to build directory, remove header files and add execute flag
        run: |
          cd build/
          rm ./*.h
          chmod +x ./*
      - name: Apple notarization
        env:
          MAC_CODE_SIGN_CERT: ${{ secrets.MAC_CODE_SIGN_CERT }}
          MAC_CODE_CONNECT_API_KEY_JSON: ${{ secrets.MAC_CODE_CONNECT_API_KEY_JSON }}
          MAC_CODE_SIGN_CERT_PASS: ${{ secrets.MAC_CODE_SIGN_CERT_PASS }}
        run: |
          cd ..
          wget https://github.com/indygreg/apple-platform-rs/releases/download/apple-codesign%2F0.27.0/apple-codesign-0.27.0-x86_64-unknown-linux-musl.tar.gz
          wget https://github.com/indygreg/apple-platform-rs/releases/download/apple-codesign%2F0.27.0/apple-codesign-0.27.0-x86_64-unknown-linux-musl.tar.gz.sha256
          echo "$(cat apple-codesign-0.27.0-x86_64-unknown-linux-musl.tar.gz.sha256) apple-codesign-0.27.0-x86_64-unknown-linux-musl.tar.gz" | sha256sum --check --status
          tar -xvf apple-codesign-0.27.0-x86_64-unknown-linux-musl.tar.gz
          cd ./go-zenon/build/
          echo "$MAC_CODE_SIGN_CERT" > /tmp/mac_code_sign_cert_base64.txt
          base64 --decode /tmp/mac_code_sign_cert_base64.txt > /tmp/mac_code_sign_cert.p12
          echo "$MAC_CODE_CONNECT_API_KEY_JSON" > /tmp/mac_code_connect_api_key.json
          echo "Signing step"
          ../../apple-codesign-0.27.0-x86_64-unknown-linux-musl/rcodesign sign --verbose --for-notarization --code-signature-flags runtime --p12-file /tmp/mac_code_sign_cert.p12 --p12-password $MAC_CODE_SIGN_CERT_PASS ./znnd-darwin-universal
          ../../apple-codesign-0.27.0-x86_64-unknown-linux-musl/rcodesign sign --verbose --for-notarization --code-signature-flags runtime --p12-file /tmp/mac_code_sign_cert.p12 --p12-password $MAC_CODE_SIGN_CERT_PASS ./znnd-darwin-amd64
          ../../apple-codesign-0.27.0-x86_64-unknown-linux-musl/rcodesign sign --verbose --for-notarization --code-signature-flags runtime --p12-file /tmp/mac_code_sign_cert.p12 --p12-password $MAC_CODE_SIGN_CERT_PASS ./znnd-darwin-arm64
          ../../apple-codesign-0.27.0-x86_64-unknown-linux-musl/rcodesign sign --verbose --for-notarization --code-signature-flags runtime --p12-file /tmp/mac_code_sign_cert.p12 --p12-password $MAC_CODE_SIGN_CERT_PASS ./libznn-darwin-universal.dylib
          ../../apple-codesign-0.27.0-x86_64-unknown-linux-musl/rcodesign sign --verbose --for-notarization --code-signature-flags runtime --p12-file /tmp/mac_code_sign_cert.p12 --p12-password $MAC_CODE_SIGN_CERT_PASS ./libznn-darwin-amd64.dylib
          ../../apple-codesign-0.27.0-x86_64-unknown-linux-musl/rcodesign sign --verbose --for-notarization --code-signature-flags runtime --p12-file /tmp/mac_code_sign_cert.p12 --p12-password $MAC_CODE_SIGN_CERT_PASS ./libznn-darwin-arm64.dylib
          echo "Notarization submission step"
          zip znnd-darwin-universal.zip ./znnd-darwin-universal && rm ./znnd-darwin-universal
          zip znnd-darwin-amd64.zip ./znnd-darwin-amd64 && rm ./znnd-darwin-amd64
          zip znnd-darwin-arm64.zip ./znnd-darwin-arm64 && rm ./znnd-darwin-arm64
          zip libznn-darwin-universal.zip ./libznn-darwin-universal.dylib && rm ./libznn-darwin-universal.dylib
          zip libznn-darwin-amd64.zip ./libznn-darwin-amd64.dylib && rm ./libznn-darwin-amd64.dylib
          zip libznn-darwin-arm64.zip ./libznn-darwin-arm64.dylib && rm ./libznn-darwin-arm64.dylib
          ../../apple-codesign-0.27.0-x86_64-unknown-linux-musl/rcodesign notary-submit --verbose --api-key-file /tmp/mac_code_connect_api_key.json ./znnd-darwin-universal.zip
          ../../apple-codesign-0.27.0-x86_64-unknown-linux-musl/rcodesign notary-submit --verbose --api-key-file /tmp/mac_code_connect_api_key.json ./znnd-darwin-amd64.zip
          ../../apple-codesign-0.27.0-x86_64-unknown-linux-musl/rcodesign notary-submit --verbose --api-key-file /tmp/mac_code_connect_api_key.json ./znnd-darwin-arm64.zip
          ../../apple-codesign-0.27.0-x86_64-unknown-linux-musl/rcodesign notary-submit --verbose --api-key-file /tmp/mac_code_connect_api_key.json ./libznn-darwin-universal.zip
          ../../apple-codesign-0.27.0-x86_64-unknown-linux-musl/rcodesign notary-submit --verbose --api-key-file /tmp/mac_code_connect_api_key.json ./libznn-darwin-amd64.zip
          ../../apple-codesign-0.27.0-x86_64-unknown-linux-musl/rcodesign notary-submit --verbose --api-key-file /tmp/mac_code_connect_api_key.json ./libznn-darwin-arm64.zip
          echo "Notarization listing step"
          ../../apple-codesign-0.27.0-x86_64-unknown-linux-musl/rcodesign notary-list --verbose --api-key-file /tmp/mac_code_connect_api_key.json
          echo "Cleanup step"
          rm /tmp/mac_code_sign_cert_base64.txt /tmp/mac_code_sign_cert.p12 /tmp/mac_code_connect_api_key.json
      - name: Archive files
        run: |
          cd build/
          for file in *windows*; do zip $(echo $file | rev | cut -d '.' -f2- | rev)".zip" "$file" && rm "$file" ; done && for so in "linux"; do for file in *"$so"*; do tar cvzf $(echo $file | rev | cut -d '.' -f2- | rev)".tar.gz" "$file" && rm "$file" ; done; done
      - name: Generate checksums
        run: | 
          cd build/
          sha256sum *
          sha256sum * > SHA256CHECKSUMS.txt
      - name: Set version
        run: |
          GOZENON=$(cat metadata/version.go | grep Version | awk -F '"' '{print $2}')
          echo "GOZENON_VERSION=$GOZENON" >> $GITHUB_ENV
      - name: Upload files to a GitHub release
        uses: svenstaro/upload-release-action@04733e069f2d7f7f0b4aebc4fbdbce8613b03ccd
        with:
          repo_token: ${{ secrets.GO_ZENON_RELEASES }}
          file: build/*
          release_name: ${{ env.GOZENON_VERSION }}
          tag: ${{ env.GOZENON_VERSION }}-alphanet
          file_glob: true
          overwrite: true
          body: ""
